#!/bin/bash

if [ "$#" -ne 2 ]; then
  echo "Usage: $0 <project> <branch>"
  exit 1
fi

$projectName=$1
branch=$2
buildsDir="builds"
branchesDir="branches"
user=$projectName
userDir="/home/$user"
branchDir="$userDir/$branchesDir/$branch"

if [[ ! -d $userDir ]]; then
  echo "Project $projectName does not exist."
  exit 1
fi

cd $userDir

if [[ ! -d $branchDir ]]; then
  echo "Branch $branch does not exist on project $projectName."
  exit 1
fi

link=$(readlink $branchDir)
cd $link || exit

echo "Stopping and removing build $link ..."
docker compose down --volumes --remove-orphans
docker container prune -f
rm -rf $link
rm $branchDir
echo "Done"
